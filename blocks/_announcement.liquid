{%- assign block_settings = block.settings -%}
{%- assign plain_text = block_settings.text | strip_newlines | strip_html | strip -%}
{%- assign block_index = section.blocks | find_index: 'id', block.id -%}
{%- assign countdown_id = block.id | replace: '_', '' | downcase -%}

{%- unless plain_text == '' -%}
  <slideshow-slide
    ref="slides[]"
    class="
      announcement-bar__slide
      text-block
      text-block--{{ block.id }}
      text-block--align-center
      text-block--full-width
      custom-typography
      {% if block_settings.font_size != "" %}custom-font-size{% endif %}
      {% if block_settings.weight != "" %}custom-font-weight{% endif %}
    "
    style="
      {% render 'typography-style', settings: block_settings, preset: 'custom' %}
      --width: 100%;
      --text-align: center;
      --line-height: 1;
    "
    {{ block.shopify_attributes }}
    aria-hidden="{% if block_index == 0 %}false{% else %}true{% endif %}"
  >
    <p class="announcement-bar__text">
      {{ block.settings.text }}
      
      {% if block_settings.enable_countdown %}
        <countdown-inline-{{ countdown_id }}
          class="countdown-inline"
          data-min-starting-count="{{ block_settings.min_starting_count }}"
          data-max-starting-count="{{ block_settings.max_starting_count }}"
          data-min-decrement-interval="{{ block_settings.min_decrement_interval }}"
          data-max-decrement-interval="{{ block_settings.max_decrement_interval }}"
          data-reset-hour="{{ block_settings.reset_hour }}"
          data-zero-behavior="{{ block_settings.zero_behavior }}"
          style="display: inline-flex; align-items: center; gap: 3px;"
        >
          <span style="color: {{ block_settings.countdown_text_color }}; font-weight: {{ block_settings.countdown_font_weight }};">
            {% if block_settings.countdown_text_before != blank %}
              {{ block_settings.countdown_text_before }}
            {% endif %}
          </span>
          <span 
            data-countdown-number 
            style="color: {{ block_settings.countdown_number_color }}; font-weight: {{ block_settings.countdown_number_weight }};"
          >
            {{ block_settings.max_starting_count }}
          </span>
          <span style="color: {{ block_settings.countdown_text_color }}; font-weight: {{ block_settings.countdown_font_weight }};">
            {% if block_settings.countdown_text_after != blank %}
              {{ block_settings.countdown_text_after }}
            {% endif %}
          </span>
        </countdown-inline-{{ countdown_id }}>
      {% endif %}
    </p>

    {% if block_settings.link != blank %}
      <a
        class="announcement-bar__link"
        href="{{ block_settings.link }}"
      >
        <span class="visually-hidden">
          {{ block_settings.text | strip_html }}
        </span>
      </a>
    {% endif %}
  </slideshow-slide>
{%- endunless -%}

{% if block_settings.enable_countdown %}
<script>
  (function() {
    class CountdownInline{{ countdown_id }} extends HTMLElement {
      constructor() {
        super();
        this.element = this;
        this.storageKey = 'countdown_{{ countdown_id }}_data';
        this.minStartingCount = parseInt(this.dataset.minStartingCount, 10) || 50;
        this.maxStartingCount = parseInt(this.dataset.maxStartingCount, 10) || 100;
        this.minDecrementInterval = (parseInt(this.dataset.minDecrementInterval, 10) || 10) * 1000; // Convert seconds to ms
        this.maxDecrementInterval = (parseInt(this.dataset.maxDecrementInterval, 10) || 30) * 1000; // Convert seconds to ms
        this.resetHour = parseInt(this.dataset.resetHour) || 0;
        this.numberElement = this.querySelector('[data-countdown-number]');
        this.currentCount = this.maxStartingCount;
        this.intervalId = null;
        
        // Debug logging
        console.log('Countdown initialized with:', {
          minStartingCount: this.minStartingCount,
          maxStartingCount: this.maxStartingCount,
          minDecrementInterval: this.minDecrementInterval / 1000 + 's',
          maxDecrementInterval: this.maxDecrementInterval / 1000 + 's'
        });
      }

      connectedCallback() {
        this.initializeCount();
        this.startCountdown();
        this.scheduleMidnightReset();
      }

      disconnectedCallback() {
        if (this.intervalId) {
          clearInterval(this.intervalId);
        }
      }

      getRandomInt(min, max) {
        // Ensure min is not greater than max
        if (min > max) {
          [min, max] = [max, min];
        }
        // Generate random integer between min and max (inclusive)
        const result = Math.floor(Math.random() * (max - min + 1)) + min;
        return result;
      }

      getRandomInterval() {
        // Generate random interval in milliseconds
        const interval = this.getRandomInt(this.minDecrementInterval, this.maxDecrementInterval);
        console.log('Next countdown interval:', interval / 1000 + ' seconds');
        return interval;
      }

      initializeCount() {
        const stored = this.getStoredData();
        const now = new Date();
        const estNow = this.convertToEST(now);
        const lastResetDate = stored ? new Date(stored.lastReset) : null;

        if (lastResetDate) {
          const lastResetEST = this.convertToEST(lastResetDate);
          const isSameDay = 
            estNow.getFullYear() === lastResetEST.getFullYear() &&
            estNow.getMonth() === lastResetEST.getMonth() &&
            estNow.getDate() === lastResetEST.getDate();

          if (isSameDay && stored.count !== undefined) {
            // Check if stored count is within current min/max range
            if (stored.count >= this.minStartingCount && stored.count <= this.maxStartingCount) {
              this.currentCount = Math.max(0, stored.count);
              console.log('Using stored count:', this.currentCount);
            } else {
              // Stored count is outside range, reset with new random value
              this.currentCount = this.getRandomInt(this.minStartingCount, this.maxStartingCount);
              console.log('Stored count outside range, generated new:', this.currentCount);
              this.saveData();
            }
          } else {
            this.resetCount();
          }
        } else {
          // First time visitor - set random starting count
          this.currentCount = this.getRandomInt(this.minStartingCount, this.maxStartingCount);
          console.log('First visit, generated random count:', this.currentCount);
          this.saveData();
        }

        this.updateDisplay();
      }

      convertToEST(date) {
        const estDate = new Date(date.toLocaleString('en-US', { timeZone: 'America/New_York' }));
        return estDate;
      }

      getStoredData() {
        try {
          const data = localStorage.getItem(this.storageKey);
          return data ? JSON.parse(data) : null;
        } catch (e) {
          return null;
        }
      }

      saveData() {
        try {
          const data = {
            count: this.currentCount,
            lastReset: new Date().toISOString(),
            lastDecrement: new Date().toISOString()
          };
          localStorage.setItem(this.storageKey, JSON.stringify(data));
        } catch (e) {
          console.error('Failed to save countdown data:', e);
        }
      }

      resetCount() {
        // Choose a new random starting count on reset
        this.currentCount = this.getRandomInt(this.minStartingCount, this.maxStartingCount);
        console.log('Reset count to:', this.currentCount);
        this.saveData();
        this.updateDisplay();
        
        // Re-show if it was hidden
        if (this.style.display === 'none') {
          this.style.display = 'inline-flex';
        }
        
        // Restart countdown if it was stopped
        if (!this.intervalId) {
          this.startCountdown();
        }
      }

      decrementCount() {
        if (this.currentCount > 0) {
          this.currentCount--;
          this.saveData();
          this.updateDisplay();
          
          if (this.currentCount === 0) {
            this.handleZeroCount();
          } else {
            // Schedule next decrement with a new random interval
            this.scheduleNextDecrement();
          }
        }
      }

      handleZeroCount() {
        const behavior = this.element.dataset.zeroBehavior || 'stop';
        
        if (behavior === 'stop') {
          if (this.intervalId) {
            clearInterval(this.intervalId);
            this.intervalId = null;
          }
        } else if (behavior === 'hide') {
          this.style.display = 'none';
          if (this.intervalId) {
            clearInterval(this.intervalId);
            this.intervalId = null;
          }
        } else if (behavior === 'reset') {
          if (this.intervalId) {
            clearInterval(this.intervalId);
            this.intervalId = null;
          }
          setTimeout(() => {
            this.resetCount();
            this.startCountdown();
          }, 1000);
        }
      }

      updateDisplay() {
        if (this.numberElement) {
          this.numberElement.textContent = this.currentCount;
        }
      }

      scheduleNextDecrement() {
        // Clear any existing interval
        if (this.intervalId) {
          clearInterval(this.intervalId);
          this.intervalId = null;
        }
        
        // Schedule next decrement with random interval
        const nextInterval = this.getRandomInterval();
        this.intervalId = setTimeout(() => {
          this.decrementCount();
        }, nextInterval);
      }

      startCountdown() {
        // Clear any existing interval first
        if (this.intervalId) {
          clearInterval(this.intervalId);
          this.intervalId = null;
        }
        
        // Start the first countdown with a random interval
        this.scheduleNextDecrement();
      }

      scheduleMidnightReset() {
        const checkReset = () => {
          const now = new Date();
          const estNow = this.convertToEST(now);
          const stored = this.getStoredData();

          if (stored && stored.lastReset) {
            const lastResetEST = this.convertToEST(new Date(stored.lastReset));
            
            // Check if we've passed the reset hour today
            const hasPassedResetHour = estNow.getHours() >= this.resetHour;
            const lastResetPassedHour = lastResetEST.getHours() >= this.resetHour;
            
            const shouldReset = 
              estNow.getFullYear() > lastResetEST.getFullYear() ||
              estNow.getMonth() > lastResetEST.getMonth() ||
              (estNow.getDate() > lastResetEST.getDate()) ||
              (estNow.getDate() === lastResetEST.getDate() && hasPassedResetHour && !lastResetPassedHour);

            if (shouldReset) {
              this.resetCount();
              this.startCountdown();
            }
          }
        };

        setInterval(checkReset, 60000);
      }
    }

    customElements.define('countdown-inline-{{ countdown_id }}', CountdownInline{{ countdown_id }});
  })();
</script>
{% endif %}

{% stylesheet %}
  .text-block:not(.text-block--full-width).rte,
  .text-block:not(.text-block--full-width).paragraph {
    /* Safari doesn't support pretty, so fallback to balance */
    text-wrap: balance;
    text-wrap: pretty;
  }

  .text-block:not(.text-block--full-width).h1,
  .text-block:not(.text-block--full-width).h2,
  .text-block:not(.text-block--full-width).h3,
  .text-block:not(.text-block--full-width).h4,
  .text-block:not(.text-block--full-width).h5,
  .text-block:not(.text-block--full-width).h6 {
    text-wrap: balance;
  }

  /* Hide underline unless text is using paragraph styles. */
  .text-block:is(.h1, .h2, .h3, .h4, .h5, .h6) a {
    text-decoration-color: transparent;
  }

  .text-block h1,
  .text-block.h1 > * {
    margin-block: var(--font-h1--spacing);
  }

  .text-block h2,
  .text-block.h2 > * {
    margin-block: var(--font-h2--spacing);
  }

  .text-block h3,
  .text-block.h3 > * {
    margin-block: var(--font-h3--spacing);
  }

  .text-block h4,
  .text-block.h4 > * {
    margin-block: var(--font-h4--spacing);
  }

  .text-block h5,
  .text-block.h5 > * {
    margin-block: var(--font-h5--spacing);
  }

  .text-block h6,
  .text-block.h6 > * {
    margin-block: var(--font-h6--spacing);
  }

  .text-block > *:first-child {
    margin-block-start: 0;
  }

  .text-block > *:last-child {
    margin-block-end: 0;
  }

  .text-block--align-center,
  .text-block--align-center > * {
    margin-inline: auto;
  }

  .text-block--align-right,
  .text-block--align-right > * {
    margin-inline-start: auto;
  }
{% endstylesheet %}

{% schema %}
{
  "name": "t:names.announcement",
  "tag": null,
  "settings": [
    {
      "type": "inline_richtext",
      "id": "text",
      "label": "t:settings.text",
      "default": "t:text_defaults.shop_our_latest_arrivals"
    },
    {
      "type": "url",
      "id": "link",
      "label": "t:settings.link"
    },
    {
      "type": "header",
      "content": "Countdown settings"
    },
    {
      "type": "checkbox",
      "id": "enable_countdown",
      "label": "Enable countdown",
      "default": false
    },
    {
      "type": "number",
      "id": "min_starting_count",
      "label": "Minimum starting count",
      "default": 50,
      "info": "Random starting count will be between min and max"
    },
    {
      "type": "number",
      "id": "max_starting_count",
      "label": "Maximum starting count",
      "default": 100,
      "info": "Random starting count will be between min and max"
    },
    {
      "type": "range",
      "id": "reset_hour",
      "label": "Daily reset time",
      "min": 0,
      "max": 23,
      "step": 1,
      "unit": "h",
      "default": 0,
      "info": "Hour (0-23) in EST when counter resets. 0 = midnight, 12 = noon"
    },
    {
      "type": "number",
      "id": "min_decrement_interval",
      "label": "Minimum decrement interval (seconds)",
      "default": 10,
      "info": "Minimum time between decrements (in seconds)"
    },
    {
      "type": "number",
      "id": "max_decrement_interval",
      "label": "Maximum decrement interval (seconds)",
      "default": 30,
      "info": "Maximum time between decrements (in seconds)"
    },
    {
      "type": "text",
      "id": "countdown_text_before",
      "label": "Countdown text before number",
      "default": "Only"
    },
    {
      "type": "text",
      "id": "countdown_text_after",
      "label": "Countdown text after number",
      "default": "units left"
    },
    {
      "type": "select",
      "id": "zero_behavior",
      "label": "When count reaches zero",
      "options": [
        {
          "value": "stop",
          "label": "Stop at 0"
        },
        {
          "value": "hide",
          "label": "Hide countdown"
        },
        {
          "value": "reset",
          "label": "Reset to starting count"
        }
      ],
      "default": "stop",
      "info": "Choose what happens when the counter hits zero"
    },
    {
      "type": "select",
      "id": "countdown_font_weight",
      "label": "Countdown text weight",
      "options": [
        {
          "value": "400",
          "label": "Normal"
        },
        {
          "value": "500",
          "label": "Medium"
        },
        {
          "value": "600",
          "label": "Semi-bold"
        },
        {
          "value": "700",
          "label": "Bold"
        }
      ],
      "default": "400"
    },
    {
      "type": "select",
      "id": "countdown_number_weight",
      "label": "Countdown number weight",
      "options": [
        {
          "value": "400",
          "label": "Normal"
        },
        {
          "value": "500",
          "label": "Medium"
        },
        {
          "value": "600",
          "label": "Semi-bold"
        },
        {
          "value": "700",
          "label": "Bold"
        }
      ],
      "default": "700"
    },
    {
      "type": "color",
      "id": "countdown_text_color",
      "label": "Countdown text color",
      "default": "#ffffff"
    },
    {
      "type": "color",
      "id": "countdown_number_color",
      "label": "Countdown number color",
      "default": "#d7b26f"
    },
    {
      "type": "header",
      "content": "t:content.typography"
    },
    {
      "type": "select",
      "id": "font",
      "label": "t:settings.font",
      "options": [
        {
          "value": "var(--font-body--family)",
          "label": "t:options.body"
        },
        {
          "value": "var(--font-subheading--family)",
          "label": "t:options.subheading"
        },
        {
          "value": "var(--font-heading--family)",
          "label": "t:options.heading"
        },
        {
          "value": "var(--font-accent--family)",
          "label": "t:options.accent"
        }
      ],
      "default": "var(--font-body--family)"
    },
    {
      "type": "select",
      "id": "font_size",
      "label": "t:settings.size",
      "options": [
        {
          "value": "",
          "label": "t:options.default"
        },
        {
          "value": "0.625rem",
          "label": "10px"
        },
        {
          "value": "0.75rem",
          "label": "12px"
        },
        {
          "value": "0.875rem",
          "label": "14px"
        },
        {
          "value": "1rem",
          "label": "16px"
        },
        {
          "value": "1.125rem",
          "label": "18px"
        },
        {
          "value": "1.25rem",
          "label": "20px"
        },
        {
          "value": "1.5rem",
          "label": "24px"
        },
        {
          "value": "2rem",
          "label": "32px"
        },
        {
          "value": "2.5rem",
          "label": "40px"
        },
        {
          "value": "3rem",
          "label": "48px"
        },
        {
          "value": "3.5rem",
          "label": "56px"
        },
        {
          "value": "4.5rem",
          "label": "72px"
        },
        {
          "value": "5.5rem",
          "label": "88px"
        },
        {
          "value": "7.5rem",
          "label": "120px"
        },
        {
          "value": "9.5rem",
          "label": "152px"
        },
        {
          "value": "11.5rem",
          "label": "184px"
        }
      ],
      "default": "1rem"
    },
    {
      "type": "select",
      "id": "weight",
      "label": "t:settings.weight",
      "options": [
        {
          "value": "",
          "label": "t:options.default"
        },
        {
          "value": "100",
          "label": "t:options.thin"
        },
        {
          "value": "300",
          "label": "t:options.light"
        },
        {
          "value": "400",
          "label": "t:options.regular"
        },
        {
          "value": "500",
          "label": "t:options.medium"
        },
        {
          "value": "600",
          "label": "t:options.semibold"
        },
        {
          "value": "700",
          "label": "t:options.bold"
        },
        {
          "value": "900",
          "label": "t:options.black"
        }
      ],
      "default": ""
    },
    {
      "type": "select",
      "id": "letter_spacing",
      "label": "t:settings.letter_spacing",
      "options": [
        {
          "value": "tight",
          "label": "t:options.tight"
        },
        {
          "value": "normal",
          "label": "t:options.normal"
        },
        {
          "value": "loose",
          "label": "t:options.loose"
        }
      ],
      "default": "normal"
    },
    {
      "type": "select",
      "id": "case",
      "label": "t:settings.case",
      "options": [
        {
          "value": "none",
          "label": "t:options.default"
        },
        {
          "value": "uppercase",
          "label": "t:options.uppercase"
        }
      ],
      "default": "none"
    }
  ],
  "presets": [
    {
      "name": "t:names.announcement",
      "settings": {
        "font": "var(--font-subheading--family)",
        "font_size": "0.75rem"
      }
    }
  ]
}
{% endschema %}
