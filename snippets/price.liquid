{%- liquid
  assign show_unit_price = show_unit_price | default: false
  assign show_sale_price_first = show_sale_price_first | default: false
  assign show_discount_badge_setting = show_discount_badge_setting | default: false

  assign selected_variant = product_resource.selected_or_first_available_variant
  assign price_raw = selected_variant.price
  assign compare_at_price_raw = selected_variant.compare_at_price

  # Flash deal logic (same source as price-list)
  assign flash_deal_price_value = product_resource.metafields.custom.flash_deal_price
  assign has_flash_deal = false

  if flash_deal_price_value != blank
    assign has_flash_deal = true
    assign price_raw = flash_deal_price_value | times: 100
  endif

  assign show_compare_price = false
  if compare_at_price_raw > price_raw
    assign show_compare_price = true
  endif

  # Calculate discount badge (only on PDP when enabled)
  assign show_discount_badge = false
  assign discount_amount = 0
  if  show_discount_badge_setting
    assign show_discount_badge = true
    assign discount_amount = compare_at_price_raw | minus: price_raw 
    
  endif

  if product_resource == blank
    assign price_raw = 1999
  endif

  # Volume pricing
  assign has_volume_pricing = false
  assign price_min_raw = null
  assign price_max_raw = null

  assign is_product_card = true
  if template.name == 'product'
    assign is_product_card = false
  endif

  if is_product_card
    assign price_min_raw = product_resource.price_min
    assign price_max_raw = product_resource.price_max
    assign has_volume_pricing = product_resource.quantity_price_breaks_configured? | default: false
  else
    if selected_variant.quantity_price_breaks.size > 0
      assign has_volume_pricing = true
      assign price_min_raw = selected_variant.quantity_price_breaks.last.price
      assign price_max_raw = selected_variant.price
    endif
  endif

  # Currency logic
  assign use_currency = false
  if product.handle == product_resource.handle
    if settings.currency_code_enabled_product_pages
      assign use_currency = true
    endif
  elsif settings.currency_code_enabled_product_cards
    assign use_currency = true
  endif

  if use_currency
    assign price = price_raw | money_with_currency
    assign compare_at_price = compare_at_price_raw | money_with_currency
    assign price_min = price_min_raw | money_with_currency
    assign price_max = price_max_raw | money_with_currency
  else
    assign price = price_raw | money
    assign compare_at_price = compare_at_price_raw | money
    assign price_min = price_min_raw | money
    assign price_max = price_max_raw | money
  endif
-%}

<div ref="priceContainer" class="price-container{% if show_discount_badge %} price-container--with-discount{% endif %}">
  {% if has_flash_deal %}
    {% if show_sale_price_first == false and product_resource.compare_at_price > product_resource.price %}
      <span role="group">
        <span class="visually-hidden">{{ 'content.price_regular' | t }}</span>
        <span class="compare-at-price">
          {%- if use_currency -%}
            {{- product_resource.compare_at_price | money_with_currency -}}
          {%- else -%}
            {{- product_resource.compare_at_price | money -}}
          {%- endif -%}
        </span>
      </span>
    {% endif %}

    <span role="group">
      <span class="visually-hidden">{{ 'content.price_sale' | t }}</span>
      <span class="price flash-deal-card-price">{{ price }}</span>
    </span>

    {% if show_sale_price_first and product_resource.compare_at_price > product_resource.price %}
      <span role="group">
        <span class="visually-hidden">{{ 'content.price_regular' | t }}&nbsp;</span>
        <span class="compare-at-price">
          {%- if use_currency -%}
            {{ product_resource.compare_at_price | money_with_currency }}
          {%- else -%}
            {{ product_resource.compare_at_price | money }}
          {%- endif -%}
        </span>
      </span>
    {% endif %}
  {% else %}

    {% if show_sale_price_first == false and show_compare_price %}
      <span role="group">
        <span class="visually-hidden">{{ 'content.price_regular' | t }}&nbsp;</span>
        <span class="compare-at-price">{{- compare_at_price -}}</span>
      </span>
    {% endif %}

    <span role="group">
      <span class="visually-hidden">{{ 'content.price_sale' | t }}&nbsp;</span>
      <span class="price">{{ price }}</span>
    </span>

    {% if show_sale_price_first and show_compare_price %}
      <span role="group">
        <span class="visually-hidden">{{ 'content.price_regular' | t }}&nbsp;</span>
        <span class="compare-at-price">{{- compare_at_price -}}</span>
      </span>
    {% endif %}
  {% endif %}
  
  {%- if show_discount_badge -%}
    <span class="price-discount-badge badge badge--primary badge--discount">{{ discount_amount | divided_by: 100.0 | floor | times: 100 | money_without_trailing_zeros }}
OFF</span>
  {%- endif -%}

  {% if selected_variant.unit_price and show_unit_price %}
    {% liquid
      if use_currency
        assign unit_price = selected_variant.unit_price | money_with_currency
      else
        assign unit_price = selected_variant.unit_price | money
      endif
    %}
    {% render 'unit-price', price: unit_price, measurement: selected_variant.unit_price_measurement %}
  {% endif %}
</div>

{% if has_volume_pricing %}
  <small class="volume-pricing-note">{{ 'content.volume_pricing_available' | t }}</small>
{% endif %}

{% stylesheet %}
  span.price.flash-deal-card-price {
    color: #fe3428!important;
  }

  .price-container {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    flex-wrap: wrap;
  }

  .price-discount-badge {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 5px 12px;
    font-size: var(--font-size--s, 14px);
    font-weight: 400;
    color: var(--color-primary-badge-text);
    background-color: var(--color-primary-badge-background);
    border: 1px solid var(--color-primary-badge-text);
    white-space: nowrap;
  }
{% endstylesheet %}